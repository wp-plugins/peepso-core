function PsPostBox(){this.can_submit=!1,this.found_url=!1,this.show_preview=!0,this.$postbox=null,this.$url_preview_container=jQuery("<div class='url-preview-container'></div>")}!function(a){a.fn.pspostbox=function(b){if(!(this.size()<=0)){var c=this;return this.$textarea=null,this.$access=null,this.$charcount=null,this.$save_button=null,this.$posttabs=null,this.$privacy_dropdown=null,this.can_submit=!1,this.init=function(b){var c=this;_opts={textarea:"textarea.ps-postbox-textarea",mirror:".ps-postbox-mirror",addons:".ps-postbox-addons",access:"#postbox_acc",save_url:"postbox.post",charcount:".post-charcount",save_button:".postbox-submit",send_button_text:void 0,text_length:peepsodata.postsize,autosize:!0},this.opts=_opts,a.extend(!0,this.opts,b),this.$posttabs=a(".ps-postbox-tab-root",this).ps_posttabs({container:this}),this.$textarea=jQuery(this.opts.textarea,this),this.$mirror=jQuery(this.opts.mirror,this),this.$addons=jQuery(this.opts.addons,this),this.$access=a(this.opts.access,this),this._default_access=this.$access.val(),this.$charcount=a(this.opts.charcount,this),this.$save_button=a(this.opts.save_button,this),_.isUndefined(this.opts.send_button_text)||this.$save_button.html(this.opts.send_button_text),this.$privacy=a("#privacy-tab",this),this.orig_height=this.$textarea.height(),this.opts.autosize&&this.$textarea.autosize(),this.$textarea.attr("maxlength",this.opts.text_length).on("keydown",function(a){c.on_keydown(a)}).on("keypress",function(a){c.on_keypress(a)}).on("paste",function(a){c.on_paste(a)}).on("focus",function(a){c.on_focus()}).on("keyup",function(a){c.on_change()}).on("input",function(a){c.on_input()}),this.$charcount.html(this.opts.text_length+""),this.$privacy_dropdown=a(".ps-privacy-dropdown",this.$privacy),jQuery("li a",this.$privacy_dropdown).on("click",function(b){var d=a(b.target).closest("a"),e=jQuery(c.$privacy.find(".interaction-icon-wrapper .pstd-secondary")),f=jQuery("#postbox_acc"),g=d.closest("#postbox-privacy");e.find("i").attr("class",d.find("i").attr("class")),f.val(d.attr("data-option-value")),g.hide()}),this.$privacy.on("click",function(a){c.privacy(a)}),jQuery("nav.ps-postbox-tab ul li a").click(this.clear_tabs),jQuery("#status-post",c).hide(),jQuery(this.$posttabs).on("peepso_posttabs_show-status",function(){jQuery("#status-post",c).hide(),jQuery(".ps-postbox-status").show()}),jQuery("#status-post",c).on("click",function(){jQuery(c.$posttabs).find("[data-tab='status']").trigger("click")}),this.$posttabs.on("peepso_posttabs_submit-status",function(){c.save_post()}),this.$posttabs.on("peepso_posttabs_cancel-status",function(){jQuery("#status-post",c).show()}),this.$posttabs.on("peepso_posttabs_submit",function(){c.$textarea.val("")}),this.$posttabs.on("peepso_posttabs_cancel",function(){c.$textarea.val(""),c.cancel_post()}),this.find(".interactions > ul > li > .interaction-icon-wrapper a").on("click",function(a,b){b||c.find(".interactions > ul > li > .interaction-icon-wrapper a").not(this).trigger("peepso.interaction-hide",[!0])}),this._load_addons()},this._load_addons=function(){var b=ps_observer.apply_filters("peepso_postbox_addons",[]);a(b).each(function(a,b){b.set_postbox(c),b.init()})},this.clear_tabs=function(){ps_observer.apply_filters("postbox_clear_tabs",null)},this.privacy=function(a){var b=this;this.$privacy_dropdown.show(),jQuery(document).on("mouseup.postbox-privacy",function(a){b.$privacy_dropdown.is(a.target)||0!==b.$privacy_dropdown.has(a.target).length||(b.$privacy_dropdown.hide(),jQuery(document).off("mouseup.postbox-privacy"))})},this.save_post=function(){var a={content:this.$textarea.val(),id:peepsodata.currentuserid,uid:peepsodata.userid,acc:this.$access.val(),type:"activity"};_.isUndefined(this.opts.postbox_req)||typeof Function!=typeof this.opts.postbox_req||(a=this.opts.postbox_req.apply(null,[a])),a=ps_observer.apply_filters(this.selector+"-postbox_req",a),this.save_post_queue||(this.save_post_queue=[]),this.save_post_queue.push(a),this.on_before_save(),this.save_post_progress||(this.save_post_progress=!0,this.save_post_execute())},this.save_post_execute=function(){if(!this.save_post_queue.length)return ps_observer.apply_filters("peepso_postbox_enter_to_send",!1)||(jQuery(".ps-postbox-loading",this).hide(),jQuery(".ps-postbox-action",this).show()),this.save_post_progress=!1,void this.on_queue_clear();var a=this.save_post_queue.shift();ps_observer.apply_filters("peepso_postbox_enter_to_send",!1)||(jQuery(".ps-postbox-action",this).hide(),jQuery(".ps-postbox-loading",this).show()),$PeepSo.disableAsync().postJson(this.opts.save_url,a,function(b){b.success?(c.on_save(b),jQuery(c).trigger("postbox.post_saved",[a,b])):c.on_error(b),c.save_post_execute()})},this.on_before_save=function(){typeof Function==typeof this.opts.on_before_save&&this.opts.on_before_save.apply(this)},this.on_save=function(a){typeof Function==typeof this.opts.on_save&&this.opts.on_save.apply(this,[a]),jQuery(this).trigger("postbox.post_saved",this)},this.on_queue_clear=function(){typeof Function==typeof this.opts.on_queue_clear&&this.opts.on_queue_clear.apply(this)},this.on_error=function(a){typeof Function==typeof this.opts.on_error?this.opts.on_error.apply(this,[a]):!1===_.isUndefined(a.errors[0])&&psmessage.show("Error",a.errors[0])},this.cancel_post=function(){this.$privacy.find("[data-option-value='"+this._default_access+"']").trigger("click"),this.$textarea.css("height",this.orig_height),this.on_change(),jQuery(this).trigger("postbox.post_cancel")},this.on_focus=function(){jQuery(".ps-postbox-tab-root",c).hide(),jQuery(".ps-postbox-tab.interactions",c).attr("data-tab-shown",this.$posttabs.current_tab().data("tab")),jQuery(".ps-postbox-tab.interactions",c).show()},this.on_keydown=function(a){if(this._go_submit=!1,13!==a.keyCode)return!0;var b=this.$textarea.val(),c=jQuery.trim(b);return!a.shiftKey&&ps_observer.apply_filters("peepso_postbox_enter_to_send",!1)&&(c.length||this.submitable(b))?(a.preventDefault(),this._go_submit=!0,this.$posttabs.on_submit(),!1):c.length?void 0:(a.preventDefault(),!1)},this.on_keypress=function(a){return this.$textarea.val()>=this.opts.text_length?!1:void 0},this.on_paste=function(a){var b=this;a.originalEvent.clipboardData.getData("text/plain").slice(0,this.text_length),setTimeout(function(){b.on_change()},100)},this.on_input=function(a){this._go_submit||ps_observer.apply_filters("peepso_postbox_input_changed",this.$textarea.val())},this.on_change=function(){var a=this.$textarea.val(),b=a.length;b=this.opts.text_length-b,0>b&&(b=0),this.$charcount.html(b+""),b>=50?this.$charcount.removeClass("alert-info").removeClass("alert-error"):0===b?pswindow.show("","You may only enter up to "+this.opts.text_length+" characters"):30>b?this.$charcount.removeClass("alert-info").addClass("alert-error"):50>b&&this.$charcount.addClass("alert-info").removeClass("alert-error"),this.submitable(a)&&!ps_observer.apply_filters("peepso_postbox_enter_to_send",!1)?this.$save_button.show():this.$save_button.hide();var c=a.replace(/\n/g,"<br>");this.$mirror.html(c),this.addons_update()},this.submitable=function(a){var b=Math.max(0,this.opts.text_length-a.length),c=ps_observer.apply_filters("peepso_postbox_can_submit",{hard:[],soft:[b<this.opts.text_length&&""!==jQuery.trim(a)]});return c=c.hard.length?c.hard.indexOf(!1)>-1?!1:!0:c.soft.indexOf(!0)>-1?!0:!1},this.addons_update=jQuery.proxy(_.debounce(function(){var a=ps_observer.apply_filters("peepso_postbox_addons_update",[]);if(a&&a.length){var b=this.$textarea.attr("placeholder");this.$textarea.data("placeholder",b).removeAttr("placeholder"),this.$addons.html("&mdash; "+a.join(" and ")),this.$addons.show()}else{var b=this.$textarea.data("placeholder");this.$textarea.attr("placeholder",b),this.$addons.hide().empty()}},10),this),this.init(b),this}}}(jQuery),PsPostBox.prototype.init=function(){var a=this;return ps_observer.add_filter("peepso_postbox_can_submit",function(b){return b?b:a.can_submit},20,1),this.$activity_stream=jQuery("#ps-activitystream"),this.$postbox=jQuery("#postbox-main").pspostbox({postbox_req:function(b){return b.show_preview=a.show_preview?"1":"0",b},on_save:function(b){return jQuery(this.$posttabs).find("[data-tab='status']").trigger("click"),a.append_to_stream(b)}}),void 0!==this.$postbox&&(this.$postbox.$textarea.on("blur",function(b){a.check_url_preview()}).on("keyup",function(b){32===b.keyCode&&a.check_url_preview()}),this.$postbox.on("postbox.post_saved postbox.post_cancel",function(){a.found_url=!1,a.show_preview=!0,a.can_submit=!1,a.$url_preview_container.empty().remove()})),this.$postbox},PsPostBox.prototype.check_url_preview=function(){if("status"===this.$postbox.$posttabs.current_tab().data("tab")&&!this.found_url){var a=this,b=/((?:(http|https|Http|Https|rtsp|Rtsp):\/\/(?:(?:[a-zA-Z0-9\$\-\_\.\+\!\*\'\(\)\,\;\?\&\=]|(?:\%[a-fA-F0-9]{2})){1,64}(?:\:(?:[a-zA-Z0-9\$\-\_\.\+\!\*\'\(\)\,\;\?\&\=]|(?:\%[a-fA-F0-9]{2})){1,25})?\@)?)?((?:(?:[a-zA-Z0-9][a-zA-Z0-9\-]{0,64}\.)+(?:(?:aero|arpa|asia|a[cdefgilmnoqrstuwxz])|(?:biz|b[abdefghijmnorstvwyz])|(?:cat|com|coop|c[acdfghiklmnoruvxyz])|d[ejkmoz]|(?:edu|e[cegrstu])|f[ijkmor]|(?:gov|g[abdefghilmnpqrstuwy])|h[kmnrtu]|(?:info|int|i[delmnoqrst])|(?:jobs|j[emop])|k[eghimnrwyz]|l[abcikrstuvy]|(?:mil|mobi|museum|m[acdghklmnopqrstuvwxyz])|(?:name|net|n[acefgilopruz])|(?:org|om)|(?:pro|p[aefghklmnrstwy])|qa|r[eouw]|s[abcdeghijklmnortuvyz]|(?:tel|travel|t[cdfghjklmnoprtvwz])|u[agkmsyz]|v[aceginu]|w[fs]|y[etu]|z[amw]))|(?:(?:25[0-5]|2[0-4][0-9]|[0-1][0-9]{2}|[1-9][0-9]|[1-9])\.(?:25[0-5]|2[0-4][0-9]|[0-1][0-9]{2}|[1-9][0-9]|[1-9]|0)\.(?:25[0-5]|2[0-4][0-9]|[0-1][0-9]{2}|[1-9][0-9]|[1-9]|0)\.(?:25[0-5]|2[0-4][0-9]|[0-1][0-9]{2}|[1-9][0-9]|[0-9])))(?:\:\d{1,5})?)(\/(?:(?:[a-zA-Z0-9\;\/\?\:\@\&\=\#\~\-\.\+\!\*\'\(\)\,\_])|(?:\%[a-fA-F0-9]{2}))*)?(?:\b|$)/gi,c=new RegExp(b),d=this.$postbox.$textarea.val().match(c),e=this.$postbox.$textarea.closest(".ps-postbox-input");if(null!==d&&jQuery(d).size()>0){jQuery(".ps-postbox-loading",this.$postbox).show(),jQuery(".ps-postbox-action",this.$postbox).hide();var f={url:d[0]};$PeepSo.postJson("postbox.get_url_preview",f,function(b){jQuery(".ps-postbox-loading",a.$postbox).hide(),jQuery(".ps-postbox-action",a.$postbox).show(),b.success&&(0===jQuery(e).find(".url-preview-container").length&&(a.$url_preview_container.html(b.data.html),jQuery(e).append(a.$url_preview_container),a.$url_preview_container.find(".remove-preview").on("click",function(b){a.show_preview=!1,b.preventDefault(),a.$url_preview_container.empty().remove(),a.can_submit=!1})),a.found_url=!0,a.can_submit=!0,a.$postbox.on_change())})}}},PsPostBox.prototype.append_to_stream=function(a){jQuery("#ps-no-posts").length>0&&(jQuery(this.$activity_stream.css("display","block")),jQuery("#ps-no-posts").remove());var b=a.data.post_id;jQuery(a.data.html).hide().prependTo(this.$activity_stream).fadeIn("slow",function(){jQuery(this).find(".comment-container").hide(),jQuery(document).trigger("ps_activitystream_append",[jQuery("#peepso-wrap .ps-js-activity--"+b+" .ps-dropdown-toggle")])}),jQuery("#peepso-wrap .ps-js-activity--"+b+" .ps-dropdown-toggle").click(dropdown_toggle_click).on("mouseenter",dropdown_toggle_mouseenter),jQuery("#peepso-wrap .ps-js-activity--"+b+" .dropdown-menu a").click(dropdown_toggle_a_click),ps_observer.apply_filters("peepso_posttabs_cancel-status")};var postbox=new PsPostBox;jQuery(document).ready(function(){postbox.init()}),jQuery(function(){if(jQuery.support.placeholder=!1,webkit_type=document.createElement("input"),"placeholder"in webkit_type&&(jQuery.support.placeholder=!0),!jQuery.support.placeholder){var a=document.activeElement;jQuery("textarea").focus(function(){jQuery(this).attr("placeholder")&&jQuery(this).attr("placeholder").length>0&&""!==jQuery(this).attr("placeholder")&&jQuery(this).val()===jQuery(this).attr("placeholder")&&jQuery(this).val("").removeClass("hasPlaceholder")}).blur(function(){jQuery(this).attr("placeholder")&&jQuery(this).attr("placeholder").length>0&&""!==jQuery(this).attr("placeholder")&&(""===jQuery(this).val()||jQuery(this).val()===jQuery(this).attr("placeholder"))&&jQuery(this).val(jQuery(this).attr("placeholder")).addClass("hasPlaceholder")}),jQuery("textarea").blur(),jQuery(a).focus(),jQuery("form").submit(function(){jQuery(this).find(".hasPlaceholder").each(function(){jQuery(this).val("")})})}});